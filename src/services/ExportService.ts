import { Project, QuickTask } from '@/types';

export class ExportService {
  static exportProjectsCSV(projects: Project[]): void {
    try {
      if (projects.length === 0) {
        throw new Error('No projects to export');
      }

      const headers = [
        '×©× ×¤×¨×•×™×§×˜', '×ª×™××•×¨', '×©× ×œ×§×•×—', '×˜×œ×¤×•×Ÿ ×¨××©×™', '×˜×œ×¤×•×Ÿ × ×•×¡×£',
        '×•×•××˜×¡××¤ ×¨××©×™', '×•×•××˜×¡××¤ × ×•×¡×£', '××™××™×™×œ', '×ª×™×§×™×™×” ××§×•××™×ª', '×§×™×©×•×¨ iCloud',
        '×¡×˜×˜×•×¡', '×¢×“×™×¤×•×ª', '××—×™×¨', '××˜×‘×¢', '×©×•×œ×', '×”×•×©×œ×',
        '×ª××¨×™×š ×™×¦×™×¨×”', '×ª××¨×™×š ×¢×“×›×•×Ÿ', '×¡×”"×› ××©×™××•×ª', '××©×™××•×ª ×”×•×©×œ××•'
      ];

      const csvData = projects.map(project => [
        project.name, project.description, project.clientName,
        project.phone1, project.phone2 || '', project.whatsapp1, project.whatsapp2 || '',
        project.email, project.folderPath || '', project.icloudLink || '',
        project.status, project.priority, project.price, project.currency,
        project.paid ? '×›×Ÿ' : '×œ×', project.completed ? '×›×Ÿ' : '×œ×',
        project.createdAt.toLocaleDateString('he-IL'), project.updatedAt.toLocaleDateString('he-IL'),
        project.tasks.length, project.tasks.filter(t => t.completed).length
      ]);

      const csv = [headers, ...csvData]
        .map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
        .join('\n');

      this.downloadFile('\ufeff' + csv, `×¤×¨×•×™×§×˜×™×-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv; charset=utf-8');
    } catch (error) {
      console.error('Error exporting projects:', error);
      throw error;
    }
  }

  static exportQuickTasksTXT(tasks: QuickTask[]): void {
    try {
      const completedTasks = tasks.filter(t => t.completed);
      const pendingTasks = tasks.filter(t => !t.completed);
      
      const content = `ğŸ“‹ ×¨×©×™××ª ××©×™××•×ª ××”×™×¨×•×ª - ××¢×¨×›×ª × ×™×”×•×œ ×¤×¨×•×™×§×˜×™× Pro
ğŸ“… ×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')} ${new Date().toLocaleTimeString('he-IL')}

ğŸ“Š ×¡×™×›×•× ××¤×•×¨×˜:
â€¢ ×¡×”"×› ××©×™××•×ª: ${tasks.length}
â€¢ ×”×•×©×œ××•: ${completedTasks.length}
â€¢ ×‘×”××ª× ×”: ${pendingTasks.length}

âœ… ××©×™××•×ª ×©×”×•×©×œ××• (${completedTasks.length}):
${completedTasks.length > 0 ? completedTasks.map((task, index) => 
  `${index + 1}. âœ“ ${task.title}
   ğŸ“… ×”×•×©×œ×: ${task.completedAt?.toLocaleDateString('he-IL') || '×œ× ×™×“×•×¢'}`
).join('\n\n') : '××™×Ÿ ××©×™××•×ª ×©×”×•×©×œ××•'}

â³ ××©×™××•×ª ×‘×”××ª× ×” (${pendingTasks.length}):
${pendingTasks.length > 0 ? pendingTasks.map((task, index) => 
  `${index + 1}. â—‹ ${task.title}
   ğŸ• × ×•×¦×¨: ${task.createdAt.toLocaleDateString('he-IL')}`
).join('\n\n') : '××™×Ÿ ××©×™××•×ª ×‘×”××ª× ×”'}

---
ğŸš€ ××¢×¨×›×ª × ×™×”×•×œ ×¤×¨×•×™×§×˜×™× Pro - ××•×ª×× macOS`;

      this.downloadFile('\ufeff' + content, `××©×™××•×ª-${new Date().toISOString().split('T')[0]}.txt`, 'text/plain; charset=utf-8');
    } catch (error) {
      console.error('Error exporting tasks:', error);
      throw error;
    }
  }

  private static downloadFile(content: string, filename: string, type: string): void {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
}