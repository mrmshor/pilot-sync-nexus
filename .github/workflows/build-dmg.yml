name: Build Native Desktop App with Tauri

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-tauri-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Install Rust dependencies
      run: |
        rustup target add x86_64-apple-darwin
        rustup target add aarch64-apple-darwin
        
    - name: Install Node dependencies
      run: npm ci
      
    - name: Install Tauri CLI
      run: |
        cargo install tauri-cli --version "^2.0" --locked
        
    - name: Create valid Tauri icons
      run: node create-valid-icons.js
      
    - name: Build React application
      run: npm run build
      
    - name: Build native Mac desktop app with Tauri
      run: |
        # Build for both Intel and Apple Silicon
        cargo tauri build --target x86_64-apple-darwin --verbose
        cargo tauri build --target aarch64-apple-darwin --verbose
        
    - name: Create universal DMG
      run: |
        # Create staging directory
        mkdir -p dmg-staging
        
        # Find and copy DMG files (handle Hebrew names)
        echo "=== Searching for DMG files ==="
        find src-tauri/target -name "*.dmg" -type f || echo "No DMG files found yet"
        
        # Intel DMG
        INTEL_DMG=$(find src-tauri/target/x86_64-apple-darwin -name "*.dmg" -type f | head -1)
        if [ -n "$INTEL_DMG" ]; then
          cp "$INTEL_DMG" "ProjectManager-Native-Desktop-Intel.dmg"
          echo "✅ Intel DMG copied: $INTEL_DMG"
        else
          echo "❌ Intel DMG not found"
        fi
        
        # Apple Silicon DMG  
        ARM_DMG=$(find src-tauri/target/aarch64-apple-darwin -name "*.dmg" -type f | head -1)
        if [ -n "$ARM_DMG" ]; then
          cp "$ARM_DMG" "ProjectManager-Native-Desktop-AppleSilicon.dmg"
          echo "✅ Apple Silicon DMG copied: $ARM_DMG"
        else
          echo "❌ Apple Silicon DMG not found"
        fi
        
        # List final files
        echo "=== Final DMG files ==="
        ls -la *.dmg || echo "No final DMG files"
        
    - name: Upload Intel DMG
      uses: actions/upload-artifact@v4
      with:
        name: ProjectManager-Native-Desktop-Intel
        path: ProjectManager-Native-Desktop-Intel.dmg
        retention-days: 30
      if: hashFiles('ProjectManager-Native-Desktop-Intel.dmg') != ''
        
    - name: Upload Apple Silicon DMG
      uses: actions/upload-artifact@v4
      with:
        name: ProjectManager-Native-Desktop-AppleSilicon
        path: ProjectManager-Native-Desktop-AppleSilicon.dmg
        retention-days: 30
      if: hashFiles('ProjectManager-Native-Desktop-AppleSilicon.dmg') != ''
        
    - name: Debug - List all build outputs
      if: failure()
      run: |
        echo "=== Tauri build directory structure ==="
        find src-tauri/target -type f -name "*.dmg" -o -name "*.app" 2>/dev/null || echo "No DMG or APP files found"
        echo "=== Current directory ==="
        ls -la
        echo "=== Bundle directory ==="
        find src-tauri/target -path "*/bundle/*" -type f 2>/dev/null || echo "No bundle files found"