name: Validate Tauri Desktop App Build Readiness

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  validate-tauri-build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Install Rust targets
      run: |
        rustup target add x86_64-apple-darwin
        rustup target add aarch64-apple-darwin
        
    - name: Install Node dependencies
      run: npm ci
      
    - name: Install Tauri CLI
      run: |
        cargo install tauri-cli --version "^2.0" --locked
        
    - name: Validate Tauri configuration
      run: |
        echo "ðŸ” Validating Tauri configuration..."
        if [ ! -f "src-tauri/tauri.conf.json" ]; then
          echo "âŒ Tauri config file missing"
          exit 1
        fi
        
        echo "âœ… Tauri config exists"
        
        
    - name: Build React application
      run: |
        echo "ðŸ” Testing React build..."
        npm run build
        echo "âœ… React build successful"
        
    - name: Validate Rust compilation
      run: |
        echo "ðŸ¦€ Validating Rust code compilation..."
        cd src-tauri
        cargo check --target x86_64-apple-darwin
        cargo check --target aarch64-apple-darwin
        echo "âœ… Rust compilation validation passed"
        
    - name: Build full Tauri desktop application
      run: |
        echo "ðŸ”¨ Building full Tauri desktop application for macOS..."
        cargo tauri build --target universal-apple-darwin
        echo "âœ… Tauri build completed successfully"
        
        echo "ðŸ“¦ Build artifacts:"
        ls -la src-tauri/target/universal-apple-darwin/release/bundle/
        
    - name: Generate validation report
      run: |
        echo "## ðŸŽ¯ Tauri Desktop Build Validation Report" > tauri-validation-report.md
        echo "- âœ… Tauri configuration: VALID" >> tauri-validation-report.md
        echo "- âœ… Icon files: DISABLED (NO ICONS REQUIRED)" >> tauri-validation-report.md
        echo "- âœ… React build: SUCCESSFUL" >> tauri-validation-report.md
        echo "- âœ… Rust compilation: VALIDATED" >> tauri-validation-report.md
        echo "- âœ… Tauri CLI: READY" >> tauri-validation-report.md
        echo "- ðŸŽ‰ **STATUS: READY FOR DESKTOP BUILD**" >> tauri-validation-report.md
        
        echo "ðŸ“Š Validation Report:"
        cat tauri-validation-report.md
        
    - name: Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: tauri-validation-report
        path: tauri-validation-report.md
        retention-days: 30