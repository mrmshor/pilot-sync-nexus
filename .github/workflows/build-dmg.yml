name: Build macOS DMG

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-dmg:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build web app
      run: npm run build
      
    - name: Setup Capacitor and build native app
      run: |
        npx cap add ios
        npx cap sync ios
        
        # Build the native iOS app for Mac
        cd ios/App
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -destination 'generic/platform=macOS,variant=Mac Catalyst' \
                   -configuration Release \
                   -archivePath ./App.xcarchive \
                   clean archive \
                   CODE_SIGN_IDENTITY="-" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO
                   
        # Export the app
        xcodebuild -exportArchive \
                   -archivePath ./App.xcarchive \
                   -exportPath ./ExportedApp \
                   -exportOptionsPlist ../../export-options.plist || \
        cp -R ./App.xcarchive/Products/Applications/ ./ExportedApp/
                   
    - name: Create DMG
      run: |
        mkdir -p dmg-contents
        
        # Copy the built app to DMG contents
        if [ -d "ios/App/ExportedApp/App.app" ]; then
          cp -R "ios/App/ExportedApp/App.app" dmg-contents/
        elif [ -d "ios/App/App.xcarchive/Products/Applications/App.app" ]; then
          cp -R "ios/App/App.xcarchive/Products/Applications/App.app" dmg-contents/
        else
          echo "App not found in expected locations"
          find ios/App -name "*.app" -type d | head -1 | xargs -I {} cp -R {} dmg-contents/
        fi
        
        # Rename the app
        find dmg-contents -name "*.app" -exec mv {} "dmg-contents/מערכת ניהול פרויקטים Pro.app" \;
        
        # Create DMG
        hdiutil create -volname "מערכת ניהול פרויקטים Pro" \
                       -srcfolder dmg-contents \
                       -ov -format UDZO \
                       "ProjectManager-macOS.dmg"
                       
    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: ProjectManager-macOS-DMG
        path: ProjectManager-macOS.dmg
        retention-days: 90
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ProjectManager-macOS.dmg
        body: |
          ## מערכת ניהול פרויקטים Pro למק
          
          ### הורדה והתקנה:
          1. הורד את קובץ ה-DMG
          2. פתח את הקובץ ולחץ כפולה על האפליקציה
          3. גרור לתיקיית Applications
          4. הפעל מתיקיית Applications
          
          ### במידה ונתקל בהודעת אבטחה:
          ```bash
          sudo xattr -rd com.apple.quarantine "/Applications/מערכת ניהול פרויקטים Pro.app"
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}