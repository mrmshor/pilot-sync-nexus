name: Bypass Icon Generation

on:
  workflow_dispatch:

jobs:
  bypass-icons:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download valid app icon
      run: |
        echo "📥 Downloading valid app icon..."
        curl -L "https://raw.githubusercontent.com/tauri-apps/tauri/dev/examples/api/app-icon.png" -o src-tauri/app-icon.png
        
    - name: Verify downloaded icon
      run: |
        echo "🔍 Verifying downloaded icon..."
        file src-tauri/app-icon.png
        ls -la src-tauri/app-icon.png
        
    - name: Create icons directory
      run: |
        echo "📁 Creating icons directory..."
        mkdir -p src-tauri/icons
        
    - name: Generate icons using ImageMagick (bypass tauri icon)
      run: |
        echo "🎨 Installing ImageMagick..."
        sudo apt-get update && sudo apt-get install -y imagemagick
        
        echo "🎨 Generating all required icons manually..."
        # Generate all required icon sizes
        convert src-tauri/app-icon.png -resize 32x32 src-tauri/icons/32x32.png
        convert src-tauri/app-icon.png -resize 128x128 src-tauri/icons/128x128.png
        convert src-tauri/app-icon.png -resize 256x256 src-tauri/icons/128x128@2x.png
        cp src-tauri/app-icon.png src-tauri/icons/icon.png
        
    - name: Verify all generated icons
      run: |
        echo "✅ Verifying all generated icons..."
        for icon in src-tauri/icons/*.png; do
          echo "📋 Checking: $icon"
          file "$icon"
          ls -la "$icon"
        done
        
    - name: Test if Tauri can now build (without icon generation)
      run: |
        echo "🔧 Installing Rust and Tauri CLI..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source ~/.cargo/env
        cargo install tauri-cli --version "^2.0" --locked
        
        echo "🏗️ Testing Tauri build (should work now)..."
        cd src-tauri
        # Skip the icon generation step entirely
        echo "Icons are already prepared manually!"
        ls -la icons/